<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - CRUD de Competências e Conquistas</title>
    <link rel="stylesheet" href="styles/desktop.css" />
    <link rel="stylesheet" href="styles/mobile.css" />
    <link rel="stylesheet" href="styles/tree.css" />
    <link rel="stylesheet" href="styles/admin.css" />
    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
      crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
      rel="stylesheet" />

  </head>
  <body>
    <div class="admin-layout">
      <!-- Modal de Conquista -->
      <div class="modal fade" id="achievementModal" tabindex="-1" aria-labelledby="achievementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <form id="achievement-modal-form">
              <input type="hidden" id="modal-achievement-id" />
              <div class="modal-header">
                <h5 class="modal-title" id="achievementModalLabel">Nova Conquista</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="modal-achievement-title" class="form-label">Título</label>
                    <input type="text" class="form-control" id="modal-achievement-title" required />
                  </div>
                  <div class="col-md-6">
                    <label for="modal-achievement-category" class="form-label">Categoria</label>
                    <div class="input-group">
                      <select class="form-select" id="modal-achievement-category">
                        <option value="QA">QA</option>
                        <option value="DEV">DEV</option>
                        <option value="SOFT">SOFT</option>
                        <option value="GESTAO">GESTÃO</option>
                      </select>
                      <div class="input-group-text">
                        <input type="checkbox" id="modal-achievement-category-new-check" title="Nova categoria" />
                      </div>
                    </div>
                    <input type="text" class="form-control mt-2 d-none" id="modal-achievement-category-new" placeholder="Digite nova categoria" />
                  </div>
                  <div class="col-md-12">
                    <label for="modal-achievement-desc" class="form-label">Descrição</label>
                    <textarea class="form-control" id="modal-achievement-desc" rows="2"></textarea>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Status</label>
                    <div class="form-check form-switch mt-2">
                      <input class="form-check-input" type="checkbox" id="modal-achievement-status-switch" checked>
                      <label class="form-check-label" for="modal-achievement-status-switch">Desbloqueada</label>
                    </div>
                    <input type="hidden" id="modal-achievement-status" value="unlocked" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Dificuldade</label>
                    <div id="modal-achievement-difficulty-stars" class="star-rating" data-score="3">
                      <i class="bi bi-star-fill"></i>
                      <i class="bi bi-star-fill"></i>
                      <i class="bi bi-star-fill"></i>
                      <i class="bi bi-star"></i>
                      <i class="bi bi-star"></i>
                    </div>
                    <input type="hidden" id="modal-achievement-difficulty" value="3" />
                  </div>
                  <div class="col-md-4">
                    <label for="modal-achievement-unlockedDate" class="form-label">Data</label>
                    <input type="date" class="form-control" id="modal-achievement-unlockedDate" />
                  </div>
                  <div class="col-md-6">
                    <label for="modal-achievement-evidence" class="form-label">Evidência (URL)</label>
                    <input type="text" class="form-control" id="modal-achievement-evidence" placeholder="https://..." />
                  </div>
                  <div class="col-md-6">
                    <label for="modal-achievement-relatedSkills" class="form-label">Skills Relacionadas</label>
                    <select class="form-select" id="modal-achievement-relatedSkills" multiple size="6" aria-describedby="modal-achievement-relatedSkills-help"></select>
                    <small id="modal-achievement-relatedSkills-help" class="form-text text-muted">Segure Ctrl (Windows) ou Cmd (Mac) para selecionar múltiplas skills.</small>
                  </div>
                  <div class="col-md-12">

                  <script>
                    // Microinteração: destaque visual ao selecionar itens no multi-select
                    document.addEventListener('DOMContentLoaded', function() {
                      function setupMultiSelectHighlight(selectId) {
                        var select = document.getElementById(selectId);
                        if (!select) return;
                        select.addEventListener('change', function() {
                          Array.from(select.options).forEach(opt => {
                            if (opt.selected) {
                              opt.classList.add('selected-option');
                            } else {
                              opt.classList.remove('selected-option');
                            }
                          });
                        });
                        // Inicializar estado visual
                        Array.from(select.options).forEach(opt => {
                          if (opt.selected) opt.classList.add('selected-option');
                        });
                      }
                      setupMultiSelectHighlight('modal-achievement-relatedSkills');
                      setupMultiSelectHighlight('modal-skill-children');
                      setupMultiSelectHighlight('modal-skill-relatedAchievements');
                    });
                  </script>

                    <label for="modal-achievement-img-url" class="form-label">Imagem (URL)</label>
                    <input type="text" class="form-control" id="modal-achievement-img-url" placeholder="https://..." />
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- Modal de Habilidade -->
      <div class="modal fade" id="skillModal" tabindex="-1" aria-labelledby="skillModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <form id="skill-modal-form">
              <!-- Campos ocultos para ID e unlock_threshold -->
              <input type="hidden" id="modal-skill-id" />
              <input type="hidden" id="modal-skill-unlock-threshold" value="0" />
              <div class="modal-header">
                <h5 class="modal-title" id="skillModalLabel">Nova Habilidade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="modal-skill-name" class="form-label">Nome</label>
                    <input type="text" class="form-control" id="modal-skill-name" required />
                  </div>
                  <div class="col-md-3">
                    <label for="modal-skill-category" class="form-label">Categoria</label>
                    <div class="input-group">
                      <select class="form-select" id="modal-skill-category">
                        <option value="QA">QA</option>
                        <option value="DEV">DEV</option>
                        <option value="SOFT">SOFT</option>
                        <option value="GESTAO">GESTÃO</option>
                      </select>
                      <div class="input-group-text">
                        <input type="checkbox" id="modal-skill-category-new-check" title="Nova categoria" />
                      </div>
                    </div>
                    <input type="text" class="form-control mt-2 d-none" id="modal-skill-category-new" placeholder="Digite nova categoria" />
                  </div>
                  <div class="col-md-3">
                    <label for="modal-skill-domain" class="form-label">Domínio <span id="modal-domain-value">3</span></label>
                    <input type="range" class="form-range" min="1" max="5" value="3" id="modal-skill-domain" />
                  </div>
                  <div class="col-md-6">
                    <label for="modal-skill-icon" class="form-label">Ícone (Bootstrap Icon)</label>
                    <input type="text" class="form-control" id="modal-skill-icon" placeholder="bi-lightbulb" />
                  </div>
                  <div class="col-md-6">
                    <label for="modal-skill-desc" class="form-label">Descrição</label>
                    <textarea class="form-control" id="modal-skill-desc" rows="2"></textarea>
                  </div>
                  <div class="col-md-6">
                    <label for="modal-skill-parent" class="form-label">Habilidade Pai (opcional)</label>
                    <select class="form-select" id="modal-skill-parent">
                      <option value="">Nenhuma</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Filhos</label>
                    <select class="form-select" id="modal-skill-children" multiple size="6" aria-describedby="modal-skill-children-help"></select>
                    <small id="modal-skill-children-help" class="form-text text-muted">Segure Ctrl (Windows) ou Cmd (Mac) para selecionar múltiplos filhos.</small>
                  </div>
                  <div class="col-md-12">
                    <label for="modal-skill-relatedAchievements" class="form-label">Conquistas Relacionadas</label>
                    <select class="form-select" id="modal-skill-relatedAchievements" multiple size="6" aria-describedby="modal-skill-relatedAchievements-help"></select>
                    <small id="modal-skill-relatedAchievements-help" class="form-text text-muted">Segure Ctrl (Windows) ou Cmd (Mac) para selecionar múltiplas conquistas.</small>
    <script>
      // Foco automático no primeiro campo relevante ao abrir modais
      document.addEventListener('DOMContentLoaded', function() {
        var achievementModal = document.getElementById('achievementModal');
        if (achievementModal) {
          achievementModal.addEventListener('shown.bs.modal', function() {
            var input = document.getElementById('modal-achievement-title');
            if (input) input.focus();
            // Microinteração: destaque visual no campo ativo
            input && input.classList.add('focus-highlight');
            input && input.addEventListener('blur', function() { input.classList.remove('focus-highlight'); }, {once:true});
          });
        }
        var skillModal = document.getElementById('skillModal');
        if (skillModal) {
          skillModal.addEventListener('shown.bs.modal', function() {
            var input = document.getElementById('modal-skill-name');
            if (input) input.focus();
            // Microinteração: destaque visual no campo ativo
            input && input.classList.add('focus-highlight');
            input && input.addEventListener('blur', function() { input.classList.remove('focus-highlight'); }, {once:true});
          });
        }
      });
    </script>
                  </div>
                  <div class="col-md-12">
                    <label class="form-label">Pontuações</label>
                    <div class="row g-2">
                      <div class="col">
                        <label class="form-label">Teórico</label>
                        <div class="star-rating" id="modal-score-theoretical-stars" data-score="3">
                          <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star"></i><i class="bi bi-star"></i>
                        </div>
                        <input type="hidden" id="modal-score-theoretical" value="3" />
                      </div>
                      <div class="col">
                        <label class="form-label">Técnico</label>
                        <div class="star-rating" id="modal-score-technical-stars" data-score="3">
                          <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star"></i><i class="bi bi-star"></i>
                        </div>
                        <input type="hidden" id="modal-score-technical" value="3" />
                      </div>
                      <div class="col">
                        <label class="form-label">Problemas</label>
                        <div class="star-rating" id="modal-score-problem-solving-stars" data-score="3">
                          <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star"></i><i class="bi bi-star"></i>
                        </div>
                        <input type="hidden" id="modal-score-problem-solving" value="3" />
                      </div>
                      <div class="col">
                        <label class="form-label">Transferência</label>
                        <div class="star-rating" id="modal-score-knowledge-transfer-stars" data-score="3">
                          <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star"></i><i class="bi bi-star"></i>
                        </div>
                        <input type="hidden" id="modal-score-knowledge-transfer" value="3" />
                      </div>
                      <div class="col">
                        <label class="form-label">Tendências</label>
                        <div class="star-rating" id="modal-score-trends-stars" data-score="3">
                          <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star"></i><i class="bi bi-star"></i>
                        </div>
                        <input type="hidden" id="modal-score-trends" value="3" />
                      </div>
                    </div>
                  </div>
    <script>
      // Estrelas interativas para pontuações no modal de habilidades
      document.addEventListener('DOMContentLoaded', function() {
        function setupStarRating(starDivId, inputId) {
          var starDiv = document.getElementById(starDivId);
          var input = document.getElementById(inputId);
          if (starDiv && input) {
            const stars = starDiv.querySelectorAll('i');
            stars.forEach((star, idx) => {
              star.addEventListener('click', function() {
                stars.forEach((s, i) => {
                  s.className = i <= idx ? 'bi bi-star-fill' : 'bi bi-star';
                });
                starDiv.dataset.score = idx + 1;
                input.value = idx + 1;
              });
            });
          }
        }
        setupStarRating('modal-score-theoretical-stars', 'modal-score-theoretical');
        setupStarRating('modal-score-technical-stars', 'modal-score-technical');
        setupStarRating('modal-score-problem-solving-stars', 'modal-score-problem-solving');
        setupStarRating('modal-score-knowledge-transfer-stars', 'modal-score-knowledge-transfer');
        setupStarRating('modal-score-trends-stars', 'modal-score-trends');
      });
    </script>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    <aside class="admin-sidebar">
      <div class="sidebar-title">
        <i class="bi bi-kanban"></i>
        <span>Admin</span>
      </div>
      <ul class="sidebar-menu">
        <li><button class="sidebar-btn active" id="sidebar-skills" onclick="showCrudSection('skills')"><i class="bi bi-lightbulb"></i> Habilidades</button></li>
        <li><button class="sidebar-btn" id="sidebar-achievements" onclick="showCrudSection('achievements')"><i class="bi bi-trophy"></i> Conquistas</button></li>
      </ul>
    </aside>
    <main class="admin-main">
      <header class="admin-header">
        <h1>Painel Admin - CRUD</h1>
      </header>
      <section class="crud-section active" id="skills-section">
        <div class="section-header d-flex justify-content-between align-items-center">
          <h2><i class="bi bi-lightbulb"></i> Habilidades</h2>
          <button class="btn btn-success" id="btnAddSkillModal" type="button"><i class="bi bi-plus-circle"></i> Nova Habilidade</button>
        </div>
        <div id="skills-list" class="card-list"></div>
      </section>
      <section class="crud-section" id="achievements-section">
        <div class="section-header d-flex justify-content-between align-items-center">
          <h2><i class="bi bi-trophy"></i> Conquistas</h2>
          <button class="btn btn-success" id="btnAddAchievementModal" type="button"><i class="bi bi-plus-circle"></i> Nova Conquista</button>
        </div>
        <div id="achievements-list" class="card-list"></div>
      </section>
    </main>
    <script>
      // Listagem de habilidades em cards horizontais col-12
      async function renderSkillsList() {
        const list = document.getElementById('skills-list');
        list.innerHTML = '<div class="text-center py-4">Carregando...</div>';
        try {
          const res = await fetch('data/skills.json');
          const data = await res.json();
          if (!data.skills || data.skills.length === 0) {
            list.innerHTML = '<div class="alert alert-info">Nenhuma habilidade encontrada.</div>';
            return;
          }
          list.innerHTML = '';
          data.skills.forEach(skill => {
            const scores = skill.scores || {};
            const related = (skill.children && skill.children.length) ? skill.children.join(', ') : '-';
            const card = document.createElement('div');
            card.className = 'card mb-3 col-12 shadow-sm';
            card.innerHTML = `
              <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
                <div class="d-flex align-items-center gap-3 flex-wrap">
                  <i class="bi ${(skill.icon || 'bi-lightbulb')} fs-2 text-primary"></i>
                  <div>
                    <h5 class="mb-1">${skill.title || ''} <small class="text-muted">#${skill.id || ''}</small></h5>
                    <div class="mb-1"><span class="badge bg-secondary">${skill.category || ''}</span> <span class="badge bg-info">${skill.domain || 0}</span> <span class="badge bg-light text-dark">${skill.parent ? 'Filho' : 'Raiz'}</span></div>
                    <div class="mb-1">${skill.description || ''}</div>
                    <div class="mb-1">
                      <span class="badge bg-warning text-dark">Teórico: ${scores.theoretical ?? '-'}</span>
                      <span class="badge bg-warning text-dark">Técnico: ${scores.technical ?? '-'}</span>
                      <span class="badge bg-warning text-dark">Problemas: ${scores.problem_solving ?? '-'}</span>
                      <span class="badge bg-warning text-dark">Transferência: ${scores.knowledge_transfer ?? '-'}</span>
                      <span class="badge bg-warning text-dark">Tendências: ${scores.trends ?? '-'}</span>
                    </div>
                    <div class="mb-1"><small class="text-muted">Filhos: ${related}</small></div>
                  </div>
                </div>
                <div class="d-flex flex-column gap-2 align-items-end">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="active-skill-${skill.id}" checked>
                    <label class="form-check-label" for="active-skill-${skill.id}">Ativo</label>
                  </div>
                  <div class="btn-group">
                    <button class="btn btn-outline-primary btn-sm btn-edit-skill" data-id="${skill.id}" title="Editar"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-outline-danger btn-sm btn-delete-skill" data-id="${skill.id}" title="Excluir"><i class="bi bi-trash"></i></button>
                  </div>
                </div>
              </div>
            `;
            list.appendChild(card);
          });
          // Adicionar eventos aos botões de editar/excluir
          list.querySelectorAll('.btn-edit-skill').forEach(btn => {
            btn.addEventListener('click', function() {
              const skillId = btn.getAttribute('data-id');
              const skill = data.skills.find(s => s.id == skillId);
              if (skill && window.showSkillModal) window.showSkillModal(skill);
            });
          });
          list.querySelectorAll('.btn-delete-skill').forEach(btn => {
            btn.addEventListener('click', function() {
              const skillId = btn.getAttribute('data-id');
              const skill = data.skills.find(s => s.id == skillId);
              if (!skill) return;
              if (confirm(`Tem certeza que deseja excluir a habilidade "${skill.title}"?`)) {
                // Remover do array global e atualizar UI
                if (window.skillsData && Array.isArray(window.skillsData.skills)) {
                  window.skillsData.skills = window.skillsData.skills.filter(s => s.id != skillId);
                  if (window.postJsonApi) window.postJsonApi('skills', window.skillsData);
                  renderSkillsList();
                  // Toast feedback
                  var toastMsg = document.getElementById('adminToastMsg');
                  toastMsg.textContent = 'Habilidade excluída com sucesso!';
                  var toast = new bootstrap.Toast(document.getElementById('adminToast'));
                  toast.show();
                }
              }
            });
          });
        } catch (e) {
          list.innerHTML = '<div class="alert alert-danger">Erro ao carregar habilidades.</div>';
        }
      }

      // Listagem de conquistas em cards horizontais col-12
      async function renderAchievementsList() {
        const list = document.getElementById('achievements-list');
        list.innerHTML = '<div class="text-center py-4">Carregando...</div>';
        try {
          const res = await fetch('data/achievements.json');
          const data = await res.json();
          if (!Array.isArray(data) || data.length === 0) {
            list.innerHTML = '<div class="alert alert-info">Nenhuma conquista encontrada.</div>';
            return;
          }
          list.innerHTML = '';
          data.forEach(ach => {
            const scores = ach.scores || {};
            const img = ach.image || ach.img || '';
            const evidence = ach.evidence ? `<a href="${ach.evidence}" target="_blank" class="badge bg-success">Evidência</a>` : '';
            const card = document.createElement('div');
            card.className = 'card mb-3 col-12 shadow-sm';
            card.innerHTML = `
              <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
                <div class="d-flex align-items-center gap-3 flex-wrap">
                  <div style="width:64px;height:64px;overflow:hidden;border-radius:8px;background:#f8f9fa;display:flex;align-items:center;justify-content:center;">
                    ${img ? `<img src="${img}" alt="img" style="max-width:100%;max-height:100%;object-fit:cover;">` : '<i class="bi bi-image fs-1 text-secondary"></i>'}
                  </div>
                  <div>
                    <h5 class="mb-1">${ach.title || ''} <small class="text-muted">#${ach.id || ''}</small></h5>
                    <div class="mb-1"><span class="badge bg-secondary">${ach.category || ''}</span> <span class="badge bg-light text-dark">${ach.status || ''}</span> <span class="badge bg-info">${ach.difficulty || '-'}</span></div>
                    <div class="mb-1">${ach.description || ''}</div>
                    <div class="mb-1">
                      <span class="badge bg-warning text-dark">Teórico: ${scores.theoretical ?? '-'}</span>
                      <span class="badge bg-warning text-dark">Técnico: ${scores.technical ?? '-'}</span>
                      <span class="badge bg-warning text-dark">Problemas: ${scores.problem_solving ?? '-'}</span>
                      <span class="badge bg-warning text-dark">Transferência: ${scores.knowledge_transfer ?? '-'}</span>
                      <span class="badge bg-warning text-dark">Tendências: ${scores.trends ?? '-'}</span>
                    </div>
                    <div class="mb-1"><small class="text-muted">Data: ${ach.unlockedDate || '-'}</small> ${evidence}</div>
                  </div>
                </div>
                <div class="d-flex flex-column gap-2 align-items-end">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="active-achievement-${ach.id}" ${ach.status !== 'locked' ? 'checked' : ''}>
                    <label class="form-check-label" for="active-achievement-${ach.id}">Ativo</label>
                  </div>
                  <div class="btn-group">
                    <button class="btn btn-outline-primary btn-sm btn-edit-achievement" data-id="${ach.id}" title="Editar"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-outline-danger btn-sm btn-delete-achievement" data-id="${ach.id}" title="Excluir"><i class="bi bi-trash"></i></button>
                  </div>
                </div>
              </div>
            `;
            list.appendChild(card);
          });
          // Adicionar eventos aos botões de editar/excluir
          list.querySelectorAll('.btn-edit-achievement').forEach(btn => {
            btn.addEventListener('click', function() {
              const achId = btn.getAttribute('data-id');
              const ach = data.find(a => a.id == achId);
              if (ach && window.showAchievementModal) window.showAchievementModal(ach);
            });
          });
          list.querySelectorAll('.btn-delete-achievement').forEach(btn => {
            btn.addEventListener('click', function() {
              const achId = btn.getAttribute('data-id');
              const ach = data.find(a => a.id == achId);
              if (!ach) return;
              if (confirm(`Tem certeza que deseja excluir a conquista "${ach.title}"?`)) {
                // Remover do array global e atualizar UI
                if (window.achievements && Array.isArray(window.achievements)) {
                  window.achievements = window.achievements.filter(a => a.id != achId);
                  if (window.postJsonApi) window.postJsonApi('achievements', window.achievements);
                  renderAchievementsList();
                  // Toast feedback
                  var toastMsg = document.getElementById('adminToastMsg');
                  toastMsg.textContent = 'Conquista excluída com sucesso!';
                  var toast = new bootstrap.Toast(document.getElementById('adminToast'));
                  toast.show();
                }
              }
            });
          });
        } catch (e) {
          list.innerHTML = '<div class="alert alert-danger">Erro ao carregar conquistas.</div>';
        }
      }

      document.addEventListener('DOMContentLoaded', function() {
        renderSkillsList();
        renderAchievementsList();
      });
    </script>
            fillRelatedAchievementsDropdown([]);
          });
        }
        // Ao submeter, coletar múltiplos selecionados
        var skillModalForm = document.getElementById('skill-modal-form');
        if (skillModalForm) {
          skillModalForm.addEventListener('submit', function(e) {
            var childrenSelect = document.getElementById('modal-skill-children');
            if (childrenSelect) {
              var selected = Array.from(childrenSelect.selectedOptions).map(opt => opt.value);
              childrenSelect.dataset.values = selected.join(',');
            }
            var relAchSelect = document.getElementById('modal-skill-relatedAchievements');
            if (relAchSelect) {
              var selected = Array.from(relAchSelect.selectedOptions).map(opt => opt.value);
              relAchSelect.dataset.values = selected.join(',');
            }
          }, true);
        }
      });
    </script>
    <script>
      // Preencher dropdown de skills relacionadas no modal de conquistas
      document.addEventListener('DOMContentLoaded', function() {
        function fillRelatedSkillsDropdown(selected = []) {
          var select = document.getElementById('modal-achievement-relatedSkills');
          if (!select) return;
          select.innerHTML = '';
          if (window.skillsData && Array.isArray(window.skillsData.skills)) {
            window.skillsData.skills.forEach(skill => {
              var opt = document.createElement('option');
              opt.value = skill.id;
              opt.textContent = skill.title + (skill.id ? ` (${skill.id})` : '');
              if (selected.includes(skill.id)) opt.selected = true;
              select.appendChild(opt);
            });
          }
        }
        // Ao abrir o modal de conquista para novo ou edição
        window.showAchievementModal = (function(origFn) {
          return function(achievement) {
            fillRelatedSkillsDropdown(achievement && achievement.relatedSkills ? achievement.relatedSkills : []);
            origFn(achievement);
          }
        })(window.showAchievementModal);
        // Ao clicar em Nova Conquista
        var btnAddAchievement = document.querySelector('#achievements-section .save-btn');
        if (btnAddAchievement) {
          btnAddAchievement.addEventListener('click', function() {
            fillRelatedSkillsDropdown([]);
          });
        }
        // Ao submeter, coletar múltiplos selecionados
        var achievementModalForm = document.getElementById('achievement-modal-form');
        if (achievementModalForm) {
          achievementModalForm.addEventListener('submit', function(e) {
            var select = document.getElementById('modal-achievement-relatedSkills');
            if (select) {
              var selected = Array.from(select.selectedOptions).map(opt => opt.value);
              document.getElementById('modal-achievement-relatedSkills').dataset.values = selected.join(',');
            }
          }, true);
        }
      });
    </script>

    <script>
      // Switch visual para status no modal de conquistas
      document.addEventListener('DOMContentLoaded', function() {
        var statusSwitch = document.getElementById('modal-achievement-status-switch');
        var statusInput = document.getElementById('modal-achievement-status');
        var statusLabel = document.querySelector('label[for="modal-achievement-status-switch"]');
        if (statusSwitch && statusInput && statusLabel) {
          statusSwitch.addEventListener('change', function() {
            if (statusSwitch.checked) {
              statusInput.value = 'unlocked';
              statusLabel.textContent = 'Desbloqueada';
            } else {
              statusInput.value = 'locked';
              statusLabel.textContent = 'Bloqueada';
            }
          });
        }
      });
    </script>

    <script>
      // Estrelas interativas para dificuldade no modal de conquistas
      document.addEventListener('DOMContentLoaded', function() {
        var starDiv = document.getElementById('modal-achievement-difficulty-stars');
        var input = document.getElementById('modal-achievement-difficulty');
        if (starDiv && input) {
          const stars = starDiv.querySelectorAll('i');
          stars.forEach((star, idx) => {
            star.addEventListener('click', function() {
              stars.forEach((s, i) => {
                s.className = i <= idx ? 'bi bi-star-fill' : 'bi bi-star';
              });
              starDiv.dataset.score = idx + 1;
              input.value = idx + 1;
            });
          });
        }
      });
    </script>

    <script>
      // Adição dinâmica de filhos no modal de habilidades
      document.addEventListener('DOMContentLoaded', function() {
        var btnAddChild = document.getElementById('btnAddChildSkill');
        var childrenList = document.getElementById('modal-skill-children-list');
        if (btnAddChild && childrenList) {
          btnAddChild.addEventListener('click', function() {
            const idx = childrenList.children.length;
            const div = document.createElement('div');
            div.className = 'input-group mb-1';
            div.innerHTML = `<input type="text" class="form-control" name="child-skill" placeholder="ID do filho">
              <button type="button" class="btn btn-outline-danger btn-sm" title="Remover" onclick="this.parentElement.remove()"><i class="bi bi-x"></i></button>`;
            childrenList.appendChild(div);
          });
        }
      });
    </script>

    <script>
      // Dropdown dinâmico para categoria de conquista
      document.addEventListener('DOMContentLoaded', function() {
        var catCheck = document.getElementById('modal-achievement-category-new-check');
        var catSelect = document.getElementById('modal-achievement-category');
        var catInput = document.getElementById('modal-achievement-category-new');
        if (catCheck && catSelect && catInput) {
          catCheck.addEventListener('change', function() {
            if (catCheck.checked) {
              catSelect.classList.add('d-none');
              catInput.classList.remove('d-none');
              catInput.focus();
            } else {
              catSelect.classList.remove('d-none');
              catInput.classList.add('d-none');
              catInput.value = '';
            }
          });
        }
      });
    </script>

    <script>
      // Dropdown dinâmico para categoria de habilidade
      document.addEventListener('DOMContentLoaded', function() {
        var catCheck = document.getElementById('modal-skill-category-new-check');
        var catSelect = document.getElementById('modal-skill-category');
        var catInput = document.getElementById('modal-skill-category-new');
        if (catCheck && catSelect && catInput) {
          catCheck.addEventListener('change', function() {
            if (catCheck.checked) {
              catSelect.classList.add('d-none');
              catInput.classList.remove('d-none');
              catInput.focus();
            } else {
              catSelect.classList.remove('d-none');
              catInput.classList.add('d-none');
              catInput.value = '';
            }
          });
        }
      });
    </script>

    <script>
      // Exemplo de uso: adicionar botão de editar nos cards de conquistas
      // (A renderização real dos cards está em scripts/admin.js, mas aqui está o padrão de chamada)
      // window.showAchievementModal(achievementObj) deve ser chamado ao clicar em editar
      // Exemplo:
      // <button onclick="showAchievementModal(achievement)">Editar</button>
      // Certifique-se de que scripts/admin.js chama showAchievementModal corretamente ao editar
    </script>

    <script>
      // Preencher modal ao editar conquista
      window.showAchievementModal = function(achievement) {
        document.getElementById('modal-achievement-id').value = achievement.id || '';
        document.getElementById('modal-achievement-title').value = achievement.title || '';
        document.getElementById('modal-achievement-category').value = achievement.category || '';
        document.getElementById('modal-achievement-desc').value = achievement.description || '';
        document.getElementById('modal-achievement-status').value = achievement.status || 'unlocked';
        document.getElementById('modal-achievement-difficulty').value = achievement.difficulty || 3;
        document.getElementById('modal-achievement-unlockedDate').value = achievement.unlockedDate || '';
        document.getElementById('modal-achievement-evidence').value = achievement.evidence || '';
        // Preencher múltipla seleção de skills relacionadas
        var select = document.getElementById('modal-achievement-relatedSkills');
        if (select && achievement.relatedSkills) {
          Array.from(select.options).forEach(opt => {
            opt.selected = achievement.relatedSkills.includes(opt.value);
          });
        }
        document.getElementById('modal-achievement-img-url').value = achievement.img || '';
        var achievementModal = new bootstrap.Modal(document.getElementById('achievementModal'));
        achievementModal.show();
      }
    </script>
    <script>
      // Abrir modal Bootstrap 5 ao clicar no botão Nova Conquista
      document.addEventListener('DOMContentLoaded', function() {
        var btnAddAchievement = document.querySelector('#achievements-section .save-btn');
        var achievementModal = new bootstrap.Modal(document.getElementById('achievementModal'));
        if (btnAddAchievement) {
          btnAddAchievement.addEventListener('click', function() {
            // Limpar todos os campos do modal antes de abrir
            document.getElementById('modal-achievement-id').value = '';
            document.getElementById('modal-achievement-title').value = '';
            document.getElementById('modal-achievement-category').value = '';
            document.getElementById('modal-achievement-desc').value = '';
            document.getElementById('modal-achievement-status').value = 'unlocked';
            document.getElementById('modal-achievement-difficulty').value = 3;
            document.getElementById('modal-achievement-unlockedDate').value = '';
            document.getElementById('modal-achievement-evidence').value = '';
            // Limpar múltipla seleção de skills relacionadas
            var select = document.getElementById('modal-achievement-relatedSkills');
            if (select) Array.from(select.options).forEach(opt => opt.selected = false);
            document.getElementById('modal-achievement-img-url').value = '';
            achievementModal.show();
          });
        }
        // Submit do modal de conquista
        var achievementModalForm = document.getElementById('achievement-modal-form');
        if (achievementModalForm) {
          achievementModalForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            var achievement = {
              id: document.getElementById('modal-achievement-id').value || undefined,
              title: document.getElementById('modal-achievement-title').value.trim(),
              category: document.getElementById('modal-achievement-category').value.trim(),
              description: document.getElementById('modal-achievement-desc').value.trim(),
              status: document.getElementById('modal-achievement-status').value,
              difficulty: parseInt(document.getElementById('modal-achievement-difficulty').value) || 3,
              unlockedDate: document.getElementById('modal-achievement-unlockedDate').value,
              evidence: document.getElementById('modal-achievement-evidence').value.trim(),
              relatedSkills: Array.from(document.getElementById('modal-achievement-relatedSkills').selectedOptions).map(opt => opt.value),
              image: document.getElementById('modal-achievement-img-url').value.trim()
            };
            // Atualizar/inserir conquista na lista global
            let updated = false;
            if (achievement.id) {
              for (let i = 0; i < window.achievements.length; i++) {
                if (window.achievements[i].id === achievement.id) {
                  window.achievements[i] = achievement;
                  updated = true;
                  break;
                }
              }
            }
            if (!updated) {
              achievement.id = achievement.id || `ach-${Date.now()}`;
              window.achievements.push(achievement);
            }
            // Persistir no backend
            if (window.postJsonApi) {
              await window.postJsonApi('achievements', window.achievements);
            }
            // Atualizar UI
            if (window.renderAchievements) window.renderAchievements();
            achievementModal.hide();
            achievementModalForm.reset();
            // Toast feedback
            var toastMsg = document.getElementById('adminToastMsg');
            toastMsg.textContent = 'Conquista salva com sucesso!';
            var toast = new bootstrap.Toast(document.getElementById('adminToast'));
            toast.show();
          });
        }
      });
    </script>
    <script>
      // Preencher modal ao editar habilidade
window.showSkillModal = async function(skill) {
  // Garante que dados globais estejam carregados
  if (!window.skillsData || !Array.isArray(window.skillsData.skills)) {
    try {
      const res = await fetch('data/skills.json');
      window.skillsData = await res.json();
    } catch {}
  }
  if (!window.achievements || !Array.isArray(window.achievements)) {
    try {
      const res = await fetch('data/achievements.json');
      window.achievements = await res.json();
    } catch {}
  }

  // Preencher campos básicos
  document.getElementById('modal-skill-id').value = skill.id || '';
  document.getElementById('modal-skill-name').value = skill.title || '';
  document.getElementById('modal-skill-icon').value = skill.icon || '';
  document.getElementById('modal-skill-desc').value = skill.description || '';
  document.getElementById('modal-skill-unlock-threshold').value = skill.unlock_threshold || 0;

  // Preencher categoria (dropdown ou campo novo)
  var catSelect = document.getElementById('modal-skill-category');
  var catInput = document.getElementById('modal-skill-category-new');
  var catCheck = document.getElementById('modal-skill-category-new-check');
  if (catSelect && catInput && catCheck) {
    if (skill.category && Array.from(catSelect.options).some(opt => opt.value === skill.category)) {
      catSelect.value = skill.category;
      catSelect.classList.remove('d-none');
      catInput.classList.add('d-none');
      catInput.value = '';
      catCheck.checked = false;
    } else if (skill.category) {
      catSelect.classList.add('d-none');
      catInput.classList.remove('d-none');
      catInput.value = skill.category;
      catCheck.checked = true;
    } else {
      catSelect.value = 'QA';
      catSelect.classList.remove('d-none');
      catInput.classList.add('d-none');
      catInput.value = '';
      catCheck.checked = false;
    }
  }

  // Preencher dropdown de Habilidade Pai
  var parentSelect = document.getElementById('modal-skill-parent');
  if (parentSelect && window.skillsData && Array.isArray(window.skillsData.skills)) {
    parentSelect.innerHTML = '<option value="">Nenhuma</option>';
    window.skillsData.skills.forEach(s => {
      if (s.id !== skill.id) {
        var opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.title + (s.id ? ` (${s.id})` : '');
        parentSelect.appendChild(opt);
      }
    });
    parentSelect.value = skill.parent || '';
  }

  // Preencher múltipla seleção de filhos
  var childrenSelect = document.getElementById('modal-skill-children');
  if (childrenSelect && window.skillsData && Array.isArray(window.skillsData.skills)) {
    childrenSelect.innerHTML = '';
    window.skillsData.skills.forEach(s => {
      if (s.id !== skill.id) {
        var opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.title + (s.id ? ` (${s.id})` : '');
        if (Array.isArray(skill.children) && skill.children.includes(s.id)) opt.selected = true;
        childrenSelect.appendChild(opt);
      }
    });
  }

  // Preencher múltipla seleção de conquistas relacionadas
  var relAchSelect = document.getElementById('modal-skill-relatedAchievements');
  if (relAchSelect && window.achievements && Array.isArray(window.achievements)) {
    relAchSelect.innerHTML = '';
    window.achievements.forEach(a => {
      var opt = document.createElement('option');
      opt.value = a.id;
      opt.textContent = a.title + (a.id ? ` (${a.id})` : '');
      if (Array.isArray(skill.relatedAchievements) && skill.relatedAchievements.includes(a.id)) opt.selected = true;
      relAchSelect.appendChild(opt);
    });
  }

  // Estrelas de pontuação e cálculo do domínio
  const scores = skill.scores || {};
  const scoreFields = [
    {star: 'modal-score-theoretical-stars', input: 'modal-score-theoretical', val: scores.theoretical ?? 3},
    {star: 'modal-score-technical-stars', input: 'modal-score-technical', val: scores.technical ?? 3},
    {star: 'modal-score-problem-solving-stars', input: 'modal-score-problem-solving', val: scores.problem_solving ?? 3},
    {star: 'modal-score-knowledge-transfer-stars', input: 'modal-score-knowledge-transfer', val: scores.knowledge_transfer ?? 3},
    {star: 'modal-score-trends-stars', input: 'modal-score-trends', val: scores.trends ?? 3}
  ];
  let soma = 0;
  scoreFields.forEach(({star, input, val}) => {
    document.getElementById(input).value = val;
    soma += Number(val) || 0;
    const starDiv = document.getElementById(star);
    if (starDiv) {
      const stars = starDiv.querySelectorAll('i');
      stars.forEach((s, i) => {
        s.className = i < val ? 'bi bi-star-fill' : 'bi bi-star';
      });
      starDiv.dataset.score = val;
    }
  });
  // Domínio = média dos scores, arredondado
  const dominio = Math.round(soma / 5);
  document.getElementById('modal-skill-domain').value = dominio;
  document.getElementById('modal-domain-value').textContent = dominio;

  var skillModal = new bootstrap.Modal(document.getElementById('skillModal'));
  skillModal.show();
}
    </script>
    </script>
    <script>
      // Abrir modal Bootstrap 5 ao clicar no botão
      document.addEventListener('DOMContentLoaded', function() {
        var btnAddSkill = document.getElementById('btnAddSkillModal');
        var skillModal = new bootstrap.Modal(document.getElementById('skillModal'));
        if (btnAddSkill) {
          btnAddSkill.addEventListener('click', function() {
            // Limpar todos os campos do modal antes de abrir
            document.getElementById('modal-skill-id').value = '';
            document.getElementById('modal-skill-name').value = '';
            document.getElementById('modal-skill-category').value = 'QA';
            document.getElementById('modal-skill-domain').value = 3;
            document.getElementById('modal-domain-value').textContent = 3;
            document.getElementById('modal-skill-icon').value = '';
            document.getElementById('modal-skill-desc').value = '';
            document.getElementById('modal-skill-unlock-threshold').value = 0;
            document.getElementById('modal-skill-parent').value = '';
            // Limpar múltipla seleção de filhos e conquistas relacionadas
            var childrenSelect = document.getElementById('modal-skill-children');
            if (childrenSelect) Array.from(childrenSelect.options).forEach(opt => opt.selected = false);
            var relAchSelect = document.getElementById('modal-skill-relatedAchievements');
            if (relAchSelect) Array.from(relAchSelect.options).forEach(opt => opt.selected = false);
            document.getElementById('modal-score-theoretical').value = 3;
            document.getElementById('modal-score-technical').value = 3;
            document.getElementById('modal-score-problem-solving').value = 3;
            document.getElementById('modal-score-knowledge-transfer').value = 3;
            document.getElementById('modal-score-trends').value = 3;
            skillModal.show();
          });
        }
        // Atualizar valor do domínio
        var domainRange = document.getElementById('modal-skill-domain');
        var domainValue = document.getElementById('modal-domain-value');
        if (domainRange && domainValue) {
          domainRange.addEventListener('input', function() {
            domainValue.textContent = domainRange.value;
          });
        }
        // Submit do modal
        var skillModalForm = document.getElementById('skill-modal-form');
        if (skillModalForm) {
          skillModalForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            var skill = {
              id: document.getElementById('modal-skill-id').value || undefined,
              title: document.getElementById('modal-skill-name').value.trim(),
              category: document.getElementById('modal-skill-category').value,
              domain: parseInt(document.getElementById('modal-skill-domain').value),
              icon: document.getElementById('modal-skill-icon').value.trim(),
              description: document.getElementById('modal-skill-desc').value.trim(),
              unlock_threshold: parseInt(document.getElementById('modal-skill-unlock-threshold').value) || 0,
              parent: document.getElementById('modal-skill-parent').value.trim() || undefined,
              children: Array.from(document.getElementById('modal-skill-children').selectedOptions).map(opt => opt.value),
              relatedAchievements: Array.from(document.getElementById('modal-skill-relatedAchievements').selectedOptions).map(opt => opt.value),
              scores: {
                theoretical: parseInt(document.getElementById('modal-score-theoretical').value) || 3,
                technical: parseInt(document.getElementById('modal-score-technical').value) || 3,
                problem_solving: parseInt(document.getElementById('modal-score-problem-solving').value) || 3,
                knowledge_transfer: parseInt(document.getElementById('modal-score-knowledge-transfer').value) || 3,
                trends: parseInt(document.getElementById('modal-score-trends').value) || 3
              }
            };
            // Atualizar/inserir skill na lista global
            let updated = false;
            if (skill.id) {
              // Editar existente
              for (let i = 0; i < window.skillsData.skills.length; i++) {
                if (window.skillsData.skills[i].id === skill.id) {
                  window.skillsData.skills[i] = skill;
                  updated = true;
                  break;
                }
              }
            }
            if (!updated) {
              // Nova skill
              skill.id = skill.id || `skill-${Date.now()}`;
              window.skillsData.skills.push(skill);
            }
            // Persistir no backend
            if (window.postJsonApi) {
              await window.postJsonApi('skills', window.skillsData);
            }
            // Atualizar UI
            if (window.renderSkills) window.renderSkills();
            skillModal.hide();
            skillModalForm.reset();
            domainValue.textContent = '3';
            // Toast feedback
            var toastMsg = document.getElementById('adminToastMsg');
            toastMsg.textContent = 'Habilidade salva com sucesso!';
            var toast = new bootstrap.Toast(document.getElementById('adminToast'));
            toast.show();
          });
        }
      });
    </script>
    <script>
      function showCrudSection(section) {
        const skillsSection = document.getElementById("skills-section");
        const achievementsSection = document.getElementById("achievements-section");
        const sidebarSkills = document.getElementById("sidebar-skills");
        const sidebarAchievements = document.getElementById("sidebar-achievements");
        if (section === "skills") {
          skillsSection.classList.add("active");
          achievementsSection.classList.remove("active");
          sidebarSkills.classList.add("active");
          sidebarAchievements.classList.remove("active");
        } else {
          skillsSection.classList.remove("active");
          achievementsSection.classList.add("active");
          sidebarSkills.classList.remove("active");
          sidebarAchievements.classList.add("active");
        }
      }
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
      crossorigin="anonymous"></script>
  </body>
</html>
